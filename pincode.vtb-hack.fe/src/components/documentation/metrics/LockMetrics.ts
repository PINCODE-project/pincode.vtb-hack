import type { MetricSection } from "./types";

/**
 * Данные метрик Блокировок для анализа настроек БД
 */
export const lockMetrics: MetricSection = {
	title: "Метрики Блокировок",
	items: [
		// Критические проблемы блокировок
		{
			title: "Долгие AccessExclusiveLock блокировки",
			metric: "Продолжительность блокировки",
			threshold: "> 10 секунд",
			level: "critical",
			description: "Блокировки AccessExclusiveLock продолжительностью более 10 секунд.",
			recommendations: [
				"Немедленно провести анализ процессов, удерживающих долгие AccessExclusiveLock блокировки",
				"Перенести DDL-операции (ALTER TABLE, DROP, TRUNCATE) в период минимальной нагрузки",
				"Использовать инструменты мониторинга для отслеживания длительных блокировок",
				"Рассмотреть использование логирования блокировок в реальном времени",
			],
		},
		{
			title: "Блокировки транзакций с долгим ожиданием",
			metric: "Время ожидания transactionid",
			threshold: "> 30 секунд",
			level: "critical",
			description: "Блокировки типа transactionid с ожиданием более 30 секунд.",
			recommendations: [
				"Выявить транзакции, вызывающие взаимоблокировки",
				"Оптимизировать порядок выполнения операций в транзакциях",
				"Установить разумные таймауты для операций",
				"Реализовать retry-логику для транзакций, подверженных блокировкам",
			],
		},
		{
			title: "Блокировки системных таблиц",
			metric: "OID таблицы",
			threshold: "< 16384 (системные таблицы)",
			level: "critical",
			description: "Блокировки на таблицах с OID < 16384 (системные таблицы).",
			recommendations: [
				"Немедленно исследовать процессы, блокирующие системные таблицы",
				"Избегать длительных транзакций, затрагивающих системные каталоги",
				"Использовать специализированные инструменты мониторинга системных блокировок",
				"Рассмотреть возможность экстренного вмешательства для разблокировки системных таблиц",
			],
		},
		// Проблемные ситуации (предупреждения)
		{
			title: "Множественные блокировки отношений",
			metric: "Количество блокировок relation",
			threshold: "> 5 одновременно",
			level: "high",
			description: "Более 5 блокировок типа relation одновременно.",
			recommendations: [
				"Проанализировать шаблоны доступа к часто блокируемым таблицам",
				"Рассмотреть возможность сегментирования горячих таблиц",
				"Оптимизировать бизнес-логику для уменьшения конкуренции за ресурсы",
				"Внедрить очередь запросов для операций с высоким уровнем конкуренции",
			],
		},
		{
			title: "Блокировки кортежей (строк)",
			metric: "Количество блокировок tuple",
			threshold: "> 10 одновременно",
			level: "high",
			description: "Более 10 блокировок типа tuple одновременно.",
			recommendations: [
				"Добавить индексы для часто обновляемых таблиц",
				"Уменьшить время удержания транзакций",
				"Разбить большие транзакции на меньшие батчи",
				"Использовать оптимистичные блокировки где это возможно",
			],
		},
		{
			title: "Долгие заблокированные запросы",
			metric: "Время ожидания разблокировки",
			threshold: "> 5 секунд",
			level: "medium",
			description: "Запросы, ожидающие разблокировки более 5 секунд.",
			recommendations: [
				"Установить параметр lock_timeout для предотвращения бесконечного ожидания",
				"Внедрить мониторинг времени ожидания блокировок",
				"Оптимизировать наиболее частые запросы, подверженные блокировкам",
				"Рассмотреть использование READ COMMITTED с дефолтными настройками",
			],
		},
		{
			title: "Процессы с частыми блокировками",
			metric: "Количество блокировок на процесс",
			threshold: "> 3 одновременно",
			level: "medium",
			description: "Процессы, создающие более 3 блокировок одновременно.",
			recommendations: [
				"Провести детальный анализ проблемных процессов",
				"Реализовать ограничение на количество одновременных операций",
				"Внедрить механизмы backoff для повторных попыток",
				"Рассмотреть балансировку нагрузки между рабочими процессами",
			],
		},
	],
};
